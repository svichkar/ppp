<project name="AntTestProject" basedir="." default="all">

	<!-- Loading property file -->
	<property file="project.properties" />
	<!-- properties that have to be overloaded -->
	<property name="release.version" value="1.1" />
	<property name="build.number" value="23" />
	<!-- define structure of folders -->
	<property name="src.dir" location="src" />
	<property name="build.dir" location="bin" />
	<property name="test.dir" location="test" />
	<property name="build.test.dir" location="bin/tests" />
	<property name="test.report.dir" location="testreport" />
	<property name="lib.dir" location="lib" />

	<path id="junit.class.path">
		<fileset dir="${lib.dir}" includes="**/*.jar" />
	</path>

	<taskdef name="junit_my"
		classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask">
		<classpath refid="junit.class.path" />
	</taskdef>

	<target name="overloading" description="Check overloading properties by values from file">
		<tstamp>
			<format property="time_start" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo
			message="${time_start} Target for validation overloading properties started" />
		<echo message="Release: ${release.version} " />
		<echo message="Build: ${build.number}" />
		<tstamp>
			<format property="time_stop" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo
			message="${time_stop} Target for validation overloading properties stoppped" />
	</target>

	<target name="init" description="Creating folders...">
		<mkdir dir="${build.dir}" />
		<mkdir dir="${build.test.dir}" />
		<mkdir dir="${test.report.dir}" />
	</target>

	<target name="clean" description="Removing folders...">
		<tstamp>
			<format property="time_start" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_start} Start to remove temporary data" />
		<delete dir="${build.dir}" />
		<delete dir="${test.report.dir}" />
		<tstamp>
			<format property="time_stop" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_stop} All temporary data was removed" />
	</target>

	<target name="compile" depends="clean, init"
		description="Compile source and test files...">
		<tstamp>
			<format property="time_start" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_start} Compile source  files..." />
		<mkdir dir="${build.dir}/classes" />
		<mkdir dir="${build.test.dir}/classes" />
		<javac includeantruntime="false" srcdir="${src.dir}" destdir="${build.dir}/classes" />
		<javac includeantruntime="false" srcdir="${test.dir}"
			destdir="${build.test.dir}/classes">
			<classpath refid="junit.class.path" />
		</javac>
		<tstamp>
			<format property="time_stop" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_stop} File compilation is done." />
	</target>

	<target name="dist" depends="compile" description="Creating jar files...">
		<tstamp>
			<format property="time_start" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_start} Creating .jar files..." />
		<mkdir dir="${build.dir}/jar" />
		<jar destfile="${build.dir}/jar/${ant.project.name}.jar" basedir="${build.dir}/classes" />
		<jar destfile="${build.test.dir}/jar/${ant.project.name}-tests.jar"
			basedir="${build.test.dir}/classes" />
		<tstamp>
			<format property="time_stop" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_stop} All .jar files were created..." />
	</target>

	<target name="all" depends="dist, test" description="Perform all tasks...">
		<tstamp>
			<format property="time_start" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_start} Perform all tasks related to project..." />

		<tstamp>
			<format property="time_stop" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_stop} All tasks related to project were executed..." />
	</target>

	<target name="compiletest" depends="init" description="Compile test files...">
		<tstamp>
			<format property="time_start" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_start} Compile test files..." />
		<mkdir dir="${build.test.dir}/classes" />
		<javac includeantruntime="false" srcdir="${test.dir}"
			destdir="${build.test.dir}/classes">
			<classpath refid="junit.class.path" />
		</javac>

		<tstamp>
			<format property="time_stop" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_stop} File compilation is done." />
	</target>

	<target name="test" depends="compiletest" description="Execution tests...">
		<tstamp>
			<format property="time_start" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_start} Execution tests started" />
		<junit_my printsummary="on" fork="true" haltonfailure="yes" showoutput="yes">
			<classpath refid="junit.class.path" />
			<classpath>
				<pathelement location="${build.test.dir}/classes" />
			</classpath>
			<formatter type="xml" />
			<formatter type="plain" />
			<batchtest todir="${test.report.dir}">
				<fileset dir="${test.dir}">
					<include name="**/*Test*" />
				</fileset>
			</batchtest>
		</junit_my>
		<tstamp>
			<format property="time_stop" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<echo message="${time_stop} Execution tests finished" />
	</target>

	<target name="zipresults">
		<echo message="Zip results of tests execution...." />
		<tstamp>
			<format property="time_start" pattern="MM_dd_yyyy_hh_mm_ss"
				unit="hour" />
		</tstamp>
		<tar compression="gzip"
			destfile="${test.report.dir}/test_results_${time_start}.tar.gz">
			<tarfileset dir="${test.report.dir}">
				<include name="*.*" />
				<exclude name="*.tar.gz" />
			</tarfileset>
		</tar>
		<echo message="All results within folder ${test.report.dir} were archived...." />
	</target>

	<target name="touchresults">
		<echo message="Changing time of creation for files...." />
		<tstamp>
			<format property="time_start" pattern="MM/dd/yyyy hh:mm:ss aa"
				unit="hour" />
		</tstamp>
		<touch datetime="${time_start}">
			<fileset dir="${test.report.dir}" />
		</touch>
		<echo message="Timestamps of files were changed...." />
	</target>

	<target name="movereporttohome">
		<echo message="Relocate archive with report to ${user.home}..." />
		<move todir="${user.home}">
			<fileset dir="${test.report.dir}">
				<include name="*.tar.gz" />
			</fileset>
		</move>
		<echo message="Relocating to ${user.home} is done..." />
	</target>

</project>